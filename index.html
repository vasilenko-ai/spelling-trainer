<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–°–ø–µ–ª–ª–∏–Ω–≥‚Äë—Ç—Ä–µ–Ω–∞–∂—ë—Ä ‚Äî –±—Ä–∞—É–∑–µ—Ä (v6.2)</title>
  <style>
    :root{--bg:#fbfbfd;--panel:#ffffff;--ink:#15171a;--muted:#6b7280;--accent:#2563eb;--good:#16a34a;--bad:#dc2626;--soft:#eef2ff;--border:#e5e7eb}
    *{box-sizing:border-box}
    html,body{max-width:100%; overflow-x:hidden;}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:#fbfbfd;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    header{position:sticky;top:0;background:rgba(251,251,253,.85);backdrop-filter:saturate(150%) blur(8px);border-bottom:1px solid var(--border);z-index:5}
    .wrap{max-width:820px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 6px;display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:var(--muted);background:#fff}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    section.panel{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px}
    label{font-weight:600}
    input[type="text"], select{width:100%;border:1px solid var(--border);border-radius:10px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.big{font-size:18px;padding:14px 18px}
    .btn.block{width:100%}
    .btn.ghost{background:var(--soft)}
    .stat{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;background:#fff;border:1px solid var(--border);border-radius:999px;font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}
    .muted{color:var(--muted)}
    .warn{color:#b45309}
    .ok{color:#16a34a} .bad{color:#dc2626}
    .timer{font-variant-numeric:tabular-nums;font-weight:700}
    .board{min-height:180px;border:1px dashed var(--border);border-radius:12px;padding:0;display:flex;align-items:center;justify-content:center;text-align:center;position:relative;overflow:hidden}
    #cnv{width:100%;height:180px;display:block;max-width:100%}
    .kbd{font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f3f4f6;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    details summary{cursor:pointer;user-select:none;list-style:none}
    details summary::-webkit-details-marker{display:none}
    .mistakes{max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
    .mistakes li{margin:6px 0}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .small{font-size:12px;color:var(--muted)}
    .picker{display:flex;align-items:center;gap:8px}
    .picker .btn{padding:10px 12px}
    .preview{margin-top:8px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px;max-height:180px;overflow:auto}
    .preview .tag{display:inline-block;margin:4px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#f9fafb}
    #validateBox{margin-top:10px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px;display:none}
    #validateBox ul{margin:6px 0 0 18px}
    .summaryLine{display:flex;align-items:center;gap:8px}
    .summaryLine .count{color:var(--muted);font-size:12px}
    .inputRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .inputRow .grow{flex:1;min-width:200px}
    @media(max-width:600px){
      .wrap{padding:12px}
      .board{min-height:140px}
      #cnv{height:140px}
      .picker{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>–°–ø–µ–ª–ª–∏–Ω–≥‚Äë—Ç—Ä–µ–Ω–∞–∂—ë—Ä ‚Äî –±—Ä–∞—É–∑–µ—Ä <span class="badge">v6.2</span></h1>
      <div class="row">
        <div class="stat">‚è±Ô∏è <span class="muted">–í—Ä–µ–º—è:</span> <span id="timer" class="timer">00:00</span></div>
        <div class="stat">üéØ <span class="muted">–¢–æ—á–Ω–æ—Å—Ç—å:</span> <span id="acc">‚Äî</span></div>
        <div class="stat">üß© <span class="muted">–°–ª–æ–≤:</span> <span id="count">0</span></div>
        <div class="right" style="margin-left:auto">
          <button class="btn" id="pauseBtn" disabled>‚è∏Ô∏è –ü–∞—É–∑–∞</button>
          <button class="btn" id="resumeBtn" disabled>‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <button class="btn" id="resetTimerBtn" disabled>üîÑ –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <div class="grid">
      <section class="panel">
        <div class="picker">
          <button class="btn" id="prevWeekBtn" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è">¬´</button>
          <label class="chip">–ù–µ–¥–µ–ª—è:
            <select id="weekSelect" style="min-width:200px"></select>
          </label>
          <button class="btn" id="nextWeekBtn" title="–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è">¬ª</button>
          <button class="btn ghost" id="shuffleBtn">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
          <label class="chip"><input type="checkbox" id="caseSensitive"> –£—á–∏—Ç—ã–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä</label>
          <label class="chip" title="–ü—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –±—É–∫–≤—ã –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ"><input type="checkbox" id="speakOnTypeTop"> üî§ –ë—É–∫–≤—ã –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ</label>
          <button class="btn" id="reloadBtn" title="–ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å lists.json">üîÉ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏</button>
        </div>

        <details id="previewWrap" style="margin-top:8px">
          <summary class="summaryLine">üìö –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –Ω–µ–¥–µ–ª–∏ <span id="previewCount" class="count"></span></summary>
          <div class="preview" id="weekPreview" aria-live="polite"></div>
        </details>

        <div id="validateBox">
          <div id="validateSummary" class="muted"></div>
          <div id="validateDetails"></div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">
        <div class="row">
          <label>–†–µ–∂–∏–º:</label>
          <label class="chip"><input type="radio" name="mode" value="lcwc" checked> Look ‚Üí Cover ‚Üí Write ‚Üí Check</label>
          <label class="chip"><input type="radio" name="mode" value="dictation"> –î–∏–∫—Ç–æ–≤–∫–∞</label>
          <label class="chip"><span class="muted">‚è±Ô∏è –ü–æ–∫–∞–∑</span>
            <input type="number" id="lookSecs" min="0" max="10" step="0.5" value="2" style="width:90px"> —Å–µ–∫
          </label>
        </div>
        <div class="row" id="voiceRow" style="display:none;margin-top:6px">
          <label class="chip" title="–ì–æ–ª–æ—Å –¥–ª—è –¥–∏–∫—Ç–æ–≤–∫–∏" style="min-width:260px"><span class="muted">üó£Ô∏è Voice</span>
            <select id="voiceSelect" style="min-width:220px"></select>
          </label>
          <label class="chip"><span class="muted">Rate</span> <input type="range" id="rate" min="0.7" max="1.3" step="0.05" value="1" style="width:160px"></label>
          <span id="ttsWarn" class="muted" style="display:none">–†–µ—á—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</span>
        </div>

        <div style="margin-top:10px">
          <button class="btn primary big block" id="startBtn">‚ñ∂Ô∏è Start quiz</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="errorsOnlyBtn" disabled>üõ†Ô∏è –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏</button>
          <button class="btn" id="clearErrorsBtn" disabled>üßπ –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏</button>
        </div>
      </section>

      <section class="panel">
        <div class="board"><canvas id="cnv" width="800" height="180"></canvas></div>
        <div id="answerRow" class="inputRow" style="margin-top:12px;display:none">
          <div class="grow">
            <input type="text" id="answer" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter"
                   autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false"
                   inputmode="latin">
          </div>
          <label class="chip" title="–ü—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –±—É–∫–≤—ã –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ"><input type="checkbox" id="speakOnType"> üî§ –ë—É–∫–≤—ã</label>
          <button class="btn" id="spellWordBtn" title="–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ —Å–ª–æ–≤–æ –ø–æ –±—É–∫–≤–∞–º">üîä –ü–æ –±—É–∫–≤–∞–º</button>
          <button class="btn" id="checkBtn">‚úÖ Check</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="repeatBtn" disabled>üîÅ Repeat</button>
          <button class="btn" id="revealBtn" disabled>üëÅÔ∏è Reveal</button>
          <button class="btn" id="skipBtn" disabled>‚è≠Ô∏è Skip</button>
          <span class="muted" id="progress" style="margin-left:auto">0 / 0</span>
        </div>
        <div id="feedback" class="muted" style="min-height:24px;margin-top:8px"></div>
        <details style="margin-top:10px"><summary>–û—à–∏–±–∫–∏</summary><ul id="mistakes" class="mistakes"></ul></details>
      </section>
    </div>
    <section class="panel" style="margin-top:14px">
      <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong>
      <div class="muted" style="margin-top:6px">
        <span class="kbd">Enter</span> ‚Äî Check / –¥–∞–ª–µ–µ ‚Ä¢ <span class="kbd">R</span> ‚Äî Repeat ‚Ä¢ <span class="kbd">S</span> ‚Äî Skip ‚Ä¢ <span class="kbd">V</span> ‚Äî Reveal ‚Ä¢ <span class="kbd">‚Üê / ‚Üí</span> ‚Äî –Ω–µ–¥–µ–ª—è ‚àí/+ ‚Ä¢ <span class="kbd">Space</span> ‚Äî –ü–∞—É–∑–∞/–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </div>
    </section>
  </main>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    // Elements
    const weekSelect=$('#weekSelect'), prevWeekBtn=$('#prevWeekBtn'), nextWeekBtn=$('#nextWeekBtn');
    const previewWrap=$('#previewWrap'), weekPreview=$('#weekPreview'), previewCount=$('#previewCount');
    const validateBox=$('#validateBox'), validateSummary=$('#validateSummary'), validateDetails=$('#validateDetails');
    const shuffleBtn=$('#shuffleBtn'), reloadBtn=$('#reloadBtn');
    const countEl=$('#count'), accEl=$('#acc'), timerEl=$('#timer');
    const startBtn=$('#startBtn'), pauseBtn=$('#pauseBtn'), resumeBtn=$('#resumeBtn'), resetTimerBtn=$('#resetTimerBtn');
    const modeRadios=document.querySelectorAll('input[name="mode"]'); const caseSensitive=$('#caseSensitive');
    const lookSecsInput=$('#lookSecs');
    const voiceRow=$('#voiceRow'), voiceSelect=$('#voiceSelect'), rate=$('#rate'), ttsWarn=$('#ttsWarn');
    const cnv=$('#cnv'), ctx=cnv.getContext('2d'); const dpr=window.devicePixelRatio||1;
    const answerRow=$('#answerRow'), answer=$('#answer'), checkBtn=$('#checkBtn'), spellWordBtn=$('#spellWordBtn');
    const repeatBtn=$('#repeatBtn'), revealBtn=$('#revealBtn'), skipBtn=$('#skipBtn'), progress=$('#progress'), feedback=$('#feedback');
    const mistakesList=$('#mistakes'), errorsOnlyBtn=$('#errorsOnlyBtn'), clearErrorsBtn=$('#clearErrorsBtn');
    const speakOnTypeTop=$('#speakOnTypeTop'), speakOnType=$('#speakOnType');

    const LISTS_URL='./lists.json';

    const store={
      saveLookSecs:(v)=>localStorage.setItem('sptr:lookSecs', String(v)),
      loadLookSecs:()=>{const v=parseFloat(localStorage.getItem('sptr:lookSecs')); return isFinite(v)?v:2;},
      saveMistakes:(m)=>localStorage.setItem('sptr:misc:m', JSON.stringify(m||[])),
      loadMistakes:()=>{try{return JSON.parse(localStorage.getItem('sptr:misc:m')||'[]')}catch(e){return []}},
      saveWeekIdx:(i)=>localStorage.setItem('sptr:weekIdx', String(i)),
      loadWeekIdx:()=>{const v=parseInt(localStorage.getItem('sptr:weekIdx')); return isFinite(v)?v:0;},
      saveVoice:(name)=>localStorage.setItem('sptr:voiceName', name||''),
      loadVoice:()=>localStorage.getItem('sptr:voiceName')||'',
      saveSpeakOnType:(v)=>localStorage.setItem('sptr:speakOnType', v?'1':'0'),
      loadSpeakOnType:()=>localStorage.getItem('sptr:speakOnType')==='1',
    };

    const state={ weeks:[], words:[], idx:0, attempts:0, correct:0, running:false,
      timerOn:false,startTs:0, elapsed:0, mode:()=>document.querySelector('input[name="mode"]:checked').value,
      phase:'idle', mistakes:[], lookTimer:null, ttsPrimed:false, lastValue:'' };

    // Fetch lists
    async function loadLists(cacheBust=false){
      try{
        const url = cacheBust ? (LISTS_URL + '?v=' + Date.now()) : LISTS_URL;
        const resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const data = await resp.json();
        if(!data || !Array.isArray(data.weeks)) throw new Error('Wrong format');
        state.weeks = data.weeks;
        populateWeeks();
      }catch(e){
        drawTextCentered('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å lists.json',{fontSize:18});
        feedback.innerHTML = '<span class="warn">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤: '+ e.message +'</span>';
      }
    }
    function populateWeeks(){
      weekSelect.innerHTML='';
      state.weeks.forEach((w,i)=>{
        const opt=document.createElement('option');
        opt.value=String(i); opt.textContent=(w.name||('Week '+(i+1)))+' ‚Äî '+(w.words?.length||0);
        weekSelect.appendChild(opt);
      });
      const idx = store.loadWeekIdx();
      weekSelect.value = String(Math.max(0, Math.min(idx, state.weeks.length-1)));
      applyWeek();
    }
    function applyWeek(){
      const idx = parseInt(weekSelect.value)||0;
      store.saveWeekIdx(idx);
      const w = state.weeks[idx] || {name:'Week', words:[]};
      setWords(w.words||[]);
      drawTextCentered('–í—ã–±—Ä–∞–Ω–æ: '+ (w.name||('Week '+(idx+1))) +' ‚Äî '+ state.words.length +' —Å–ª–æ–≤',{fontSize:18});
      renderPreview();
      runValidation(false);
    }

    // Week navigation
    function changeWeek(delta){
      let idx = parseInt(weekSelect.value)||0;
      idx = idx + delta;
      if(idx<0) idx = state.weeks.length-1;
      if(idx>=state.weeks.length) idx = 0;
      weekSelect.value = String(idx);
      applyWeek();
    }
    document.getElementById('prevWeekBtn').addEventListener('click', ()=>changeWeek(-1));
    document.getElementById('nextWeekBtn').addEventListener('click', ()=>changeWeek(1));
    document.addEventListener('keydown', (e)=>{
      const tag=(document.activeElement && document.activeElement.tagName) || '';
      if(['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
      if(e.key==='ArrowLeft') changeWeek(-1);
      if(e.key==='ArrowRight') changeWeek(1);
    });
    weekSelect.addEventListener('change', applyWeek);

    // Preview
    function renderPreview(){
      document.getElementById('previewCount').textContent = '('+state.words.length+' —Å–ª–æ–≤)';
      weekPreview.innerHTML = state.words.length
        ? state.words.map(w=>'<span class="tag">'+escapeHtml(w)+'</span>').join('')
        : '<span class="muted">–í —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤</span>';
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // Validation
    const reWord = /^[A-Za-z]+(?:['‚Äô\-][A-Za-z]+)*$/;
    const MAXLEN = 32;
    function normalizeKey(w){ return (w||'').toLowerCase().replace(/[‚Äô]/g,"'"); }
    function validateWords(words){
      const issues = { invalid:[], tooLong:[], duplicates:[] };
      const seen = new Map();
      words.forEach((w,i)=>{
        if(typeof w!=='string' || !w.trim()){ issues.invalid.push({w, i, reason:'–ø—É—Å—Ç–æ/–Ω–µ —Å—Ç—Ä–æ–∫–∞'}); return; }
        const ww = w.trim();
        if(ww.length>MAXLEN){ issues.tooLong.push({w:ww, i}); }
        if(!reWord.test(ww)){ issues.invalid.push({w:ww, i, reason:'–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã'}); }
        const key = normalizeKey(ww);
        if(seen.has(key)){ issues.duplicates.push({w:ww, first:seen.get(key), i}); } else { seen.set(key, i); }
      });
      const ok = !issues.invalid.length && !issues.tooLong.length && !issues.duplicates.length;
      return { ok, issues };
    }
    function runValidation(blockOnFail){
      const {ok, issues} = validateWords(state.words);
      if(ok){
        validateBox.style.display='none';
        startBtn.disabled=false;
        return true;
      } else {
        const parts = [];
        if(issues.invalid.length) parts.push('–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö: '+issues.invalid.length);
        if(issues.tooLong.length) parts.push('—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö: '+issues.tooLong.length);
        if(issues.duplicates.length) parts.push('–¥—É–±–ª–∏–∫–∞—Ç–æ–≤: '+issues.duplicates.length);
        validateSummary.innerHTML = '<span class="bad">–ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫</span> ‚Äî ' + parts.join(', ');
        let html='';
        if(issues.invalid.length){
          html += '<div class="warn"><b>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–ª–æ–≤–∞</b><ul>'+ issues.invalid.slice(0,20).map(x=>'<li>['+(x.i+1)+'] '+escapeHtml(x.w)+' <span class="muted">('+x.reason+')</span></li>').join('') + (issues.invalid.length>20? '<li>‚Ä¶</li>':'' ) +'</ul></div>';
        }
        if(issues.tooLong.length){
          html += '<div class="warn"><b>–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ (&gt;'+MAXLEN+')</b><ul>'+ issues.tooLong.slice(0,20).map(x=>'<li>['+(x.i+1)+'] '+escapeHtml(x.w)+'</li>').join('') + (issues.tooLong.length>20? '<li>‚Ä¶</li>':'' ) +'</ul></div>';
        }
        if(issues.duplicates.length){
          html += '<div class="warn"><b>–î—É–±–ª–∏–∫–∞—Ç—ã (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞/–∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞)</b><ul>'+ issues.duplicates.slice(0,20).map(x=>'<li>['+(x.i+1)+'] '+escapeHtml(x.w)+' <span class="muted">(–ø–µ—Ä–≤–æ–µ –≤ –ø–æ–∑–∏—Ü–∏–∏ '+(x.first+1)+')</span></li>').join('') + (issues.duplicates.length>20? '<li>‚Ä¶</li>':'' ) +'</ul></div>';
        }
        validateDetails.innerHTML = html;
        validateBox.style.display='block';
        if(blockOnFail){
          validateBox.scrollIntoView({behavior:'smooth', block:'center'});
          startBtn.disabled=true;
          return false;
        } else {
          startBtn.disabled=false;
          return false;
        }
      }
    }

    // Timer
    let tickId=null;
    function startTimer(){ if(state.timerOn) return; state.timerOn=true; state.startTs=Date.now(); tickId=setInterval(updateTimer,250); toggleTimerBtns(); }
    function pauseTimer(){ if(!state.timerOn) return; state.elapsed += Date.now()-state.startTs; state.timerOn=false; clearInterval(tickId); tickId=null; toggleTimerBtns(); }
    function resetTimer(){ state.elapsed=0; if(state.timerOn){ state.startTs=Date.now(); } updateTimer(); toggleTimerBtns(); }
    function updateTimer(){ const ms=state.timerOn? state.elapsed+(Date.now()-state.startTs): state.elapsed; const sec=Math.floor(ms/1000); const m=('0'+Math.floor(sec/60)).slice(-2); const s=('0'+(sec%60)).slice(-2); timerEl.textContent=m+':'+s; }
    function toggleTimerBtns(){ resetTimerBtn.disabled=(state.elapsed===0 && !state.timerOn); pauseBtn.disabled=!state.timerOn; resumeBtn.disabled=state.timerOn || (!state.running && state.elapsed===0); }

    // Canvas
    function resizeCanvas(){ const r=cnv.getBoundingClientRect(); const w=Math.max(1,Math.floor(r.width*dpr)); const h=Math.max(1,Math.floor(r.height*dpr)); if(cnv.width!==w||cnv.height!==h){ cnv.width=w; cnv.height=h; } ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
    function clearCanvas(){ ctx.clearRect(0,0,cnv.width,cnv.height); }
    function drawTextCentered(text, opts){ opts=opts||{}; resizeCanvas(); clearCanvas(); const r=cnv.getBoundingClientRect(); let w=r.width, h=r.height; let fontSize=opts.fontSize||32; const fam=opts.fontFamily||'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'; ctx.fillStyle=opts.color||'#15171a'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='600 '+fontSize+'px '+fam; while(ctx.measureText(text).width>w*0.9 && fontSize>14){ fontSize -= 2; ctx.font='600 '+fontSize+'px '+fam; } ctx.fillText(text, w/2, h/2); }
    const maskWord=(w)=> w.replace(/\S/g,'‚Ä¢');

    // TTS
    let voices=[]; const hasTTS=('speechSynthesis' in window);
    function fillVoices(){ if(!hasTTS) return; voices = window.speechSynthesis.getVoices(); voiceSelect.innerHTML='';
      const stored = store.loadVoice();
      const en = voices.filter(v=>/^en(-|$)/i.test(v.lang));
      const preferOrder = ['Samantha','Daniel','Alex','Moira','Serena','Tessa','Victoria','Zoe','Allison','Ava','Nicky','Joanna','Matthew','Amy','Brian','Emma','Google US English'];
      function score(v){
        let s=0;
        if(v.lang.startsWith('en-US')) s+=5;
        if(v.lang.startsWith('en-GB')) s+=4;
        if(/en-AU/.test(v.lang)) s+=0;
        if(/karen/i.test(v.name)) s-=5;
        const idx = preferOrder.findIndex(n=>v.name.includes(n));
        if(idx>=0) s += (preferOrder.length-idx);
        return s;
      }
      const sorted = (en.length? en : voices.slice()).sort((a,b)=>score(b)-score(a));
      sorted.forEach(v=>{
        const o=document.createElement('option');
        o.value=v.name; o.textContent=v.name+' ‚Äî '+v.lang;
        voiceSelect.appendChild(o);
      });
      const toSelect = (stored && voices.find(v=>v.name===stored)) ? stored : (sorted[0]?.name || '');
      if(toSelect){ voiceSelect.value = toSelect; store.saveVoice(toSelect); }
    }
    function getSelectedVoice(){
      const name = voiceSelect.value || store.loadVoice();
      if(!hasTTS) return null;
      const list = window.speechSynthesis.getVoices();
      const match = list.find(v=>v.name===name);
      return match || list.find(v=>/^en(-|$)/i.test(v.lang)) || list[0] || null;
    }
    function ensureVoicesReady(timeout){ timeout=timeout||2500; return new Promise(res=>{
      if(!hasTTS) return res(false);
      const start=Date.now();
      (function wait(){
        const got = window.speechSynthesis.getVoices();
        if(got.length || Date.now()-start>timeout){ fillVoices(); res(got.length>0); } else { setTimeout(wait,100); }
      })();
    }); }
    function primeTTS(){ if(!hasTTS || state.ttsPrimed) return; try{ const u=new SpeechSynthesisUtterance(' '); u.volume=0; window.speechSynthesis.speak(u); state.ttsPrimed=true; }catch(e){} }
    function speak(text, opts){
      if(!hasTTS) return;
      window.speechSynthesis.cancel();
      try{ window.speechSynthesis.resume(); }catch(e){}
      const u=new SpeechSynthesisUtterance(text);
      const v = getSelectedVoice();
      if(v){ u.voice=v; u.lang=v.lang; }
      if(opts && typeof opts.rate==='number') u.rate = opts.rate; else u.rate=parseFloat(rate?.value||'1');
      window.speechSynthesis.speak(u);
    }
    if(hasTTS){ window.speechSynthesis.onvoiceschanged=fillVoices; } else { ttsWarn.style.display='inline'; }
    voiceSelect?.addEventListener('change', ()=>{ store.saveVoice(voiceSelect.value); });

    // Flow
    function setWords(words){ state.words = words.slice(); state.idx=0; displayCount(); }
    function displayCount(){ countEl.textContent=String(state.words.length); progress.textContent=String(Math.min(state.idx+1,state.words.length))+' / '+String(state.words.length); }
    function accuracy(){ return state.attempts? Math.round(100*state.correct/state.attempts): null; }
    function showAcc(){ const a=accuracy(); accEl.textContent=(a==null? '‚Äî' : (state.correct+' / '+state.attempts+' ('+a+'%)')); }

    function startQuiz(){
      if(!runValidation(true)) return;
      if(!state.words.length){ drawTextCentered('–í —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –Ω–µ—Ç —Å–ª–æ–≤',{fontSize:18}); return; }
      state.running=true; state.attempts=0; state.correct=0; showAcc(); displayCount(); state.idx=0; answer.value=''; state.lastValue='';
      previewWrap.open = false;
      if(state.mode()==='lcwc'){ enterLook(); } else { dictationStart(); }
      startTimer(); enableRunBtns(true);
    }
    function enableRunBtns(e){ [repeatBtn,revealBtn,skipBtn,checkBtn,spellWordBtn].forEach(b=>b.disabled=!e); pauseBtn.disabled=!e || !state.timerOn; resetTimerBtn.disabled=!e && state.elapsed===0; answerRow.style.display=e? 'flex':'none'; }
    function nextWord(){ state.idx=(state.idx+1)%Math.max(1,state.words.length); displayCount(); }
    function clearLookTimer(){ if(state.lookTimer){ clearTimeout(state.lookTimer); state.lookTimer=null; } }
    function enterLook(){ clearLookTimer(); state.phase='look'; const w=state.words[state.idx]||''; drawTextCentered(w,{fontSize:32}); answerRow.style.display='none'; feedback.textContent=''; state.lookTimer=setTimeout(()=>enterCover(), Math.max(0, lookSecs()*1000)); }
    function enterCover(){ clearLookTimer(); state.phase='cover'; const w=state.words[state.idx]||''; drawTextCentered(maskWord(w),{fontSize:32, fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Courier New\", monospace'}); answerRow.style.display='flex'; answer.focus({preventScroll:false}); }
    function renderDictation(first){ drawTextCentered('–°–ª—É—à–∞–π —Å–ª–æ–≤–æ –∏ –Ω–∞–ø–∏—à–∏ –µ–≥–æ',{fontSize:18}); answerRow.style.display='flex'; answer.focus({preventScroll:false}); progress.textContent=String(Math.min(state.idx+1,state.words.length))+' / '+String(state.words.length); if(first) dictate(); }
    function dictationStart(){ primeTTS(); ensureVoicesReady().then(()=>{ voiceRow.style.display='flex'; renderDictation(true); }); }
    function dictate(){ const w=state.words[state.idx]||''; speak(w); }
    function repeat(){ if(state.mode()==='lcwc'){ enterLook(); } else { dictate(); } }
    function reveal(){ const w=state.words[state.idx]||''; drawTextCentered(w,{fontSize:32}); }
    function skip(){ if(state.mode()==='lcwc'){ nextWord(); enterLook(); } else { nextWord(); renderDictation(true); } }
    function checkAnswer(){
      const w=state.words[state.idx]||''; const typedRaw=answer.value||'';
      const typed=caseSensitive.checked? typedRaw.trim(): typedRaw.trim().toLowerCase();
      const target=caseSensitive.checked? w.trim(): w.trim().toLowerCase();
      const ok=(typed===target); state.attempts++; if(ok) state.correct++; showAcc();
      if(!ok){ addMistake({word:w, typed:typedRaw}); }
      feedback.innerHTML = ok? '<span class="ok">–í–µ—Ä–Ω–æ!</span>' : '<span class="bad">–ù–µ–≤–µ—Ä–Ω–æ</span>: <b>'+ (typedRaw||'‚àÖ') +'</b> ‚Üí <b>'+ w +'</b>';
      answer.value=''; state.lastValue=''; nextWord(); if(state.mode()==='lcwc'){ enterLook(); } else { renderDictation(true); }
    }

    // Per-letter spelling while typing
    const LETTER_NAME = {
      a:'a', b:'b', c:'c', d:'d', e:'e', f:'f', g:'g', h:'h', i:'i', j:'j', k:'k', l:'l',
      m:'m', n:'n', o:'o', p:'p', q:'q', r:'r', s:'s', t:'t', u:'u', v:'v', w:'w', x:'x', y:'y', z:'z',
      '-':'dash', "'":"apostrophe"
    };
    function speakLetter(ch){
      if(!isSpeakOn()) return;
      if(!/^[A-Za-z'-]$/.test(ch)) return;
      primeTTS(); ensureVoicesReady(1200).then(()=>{
        window.speechSynthesis.cancel();
        const name = LETTER_NAME[ch.toLowerCase()] || ch.toLowerCase();
        speak(name, {rate:1.0});
      });
    }
    // Sync two toggles
    function isSpeakOn(){ return speakOnType.checked || speakOnTypeTop.checked; }
    function setSpeakOn(v){
      speakOnType.checked = v; speakOnTypeTop.checked = v; store.saveSpeakOnType(v);
    }
    speakOnType.addEventListener('change', ()=>setSpeakOn(speakOnType.checked));
    speakOnTypeTop.addEventListener('change', ()=>setSpeakOn(speakOnTypeTop.checked));

    // Input-based (works on iOS virtual keyboard)
    answer.addEventListener('input', (e)=>{
      if(!isSpeakOn()) return;
      const val = answer.value;
      if(val.length>state.lastValue.length){
        const ch = val.slice(-1);
        speakLetter(ch);
      }
      state.lastValue = val;
    });
    // Fallback for hardware keyboards
    answer.addEventListener('keydown', (e)=>{
      if(!isSpeakOn()) return;
      if(e.key.length===1){ speakLetter(e.key); }
    });

    // "Spell word" button
    spellWordBtn.addEventListener('click', ()=>{
      if(!answer.value) return;
      const seq = answer.value.split('');
      (async function sayLetters(){
        for(const ch of seq){
          await new Promise(r=>{
            const u = new SpeechSynthesisUtterance((LETTER_NAME[ch.toLowerCase()]||ch.toLowerCase()));
            const v = getSelectedVoice();
            if(v){ u.voice=v; u.lang=v.lang; }
            u.rate=parseFloat(rate?.value||'1');
            u.onend=r;
            window.speechSynthesis.speak(u);
          });
        }
      })();
    });

    // Mistakes persistent
    function addMistake(m){ state.mistakes.push(m); store.saveMistakes(state.mistakes); const li=document.createElement('li'); li.textContent='‚Ä¢ '+m.word+' ‚Äî –≤—ã –≤–≤–µ–ª–∏: '+(m.typed||'‚àÖ'); mistakesList.appendChild(li); errorsOnlyBtn.disabled=false; clearErrorsBtn.disabled=false; }
    function loadMistakesUI(){ mistakesList.innerHTML=''; state.mistakes.forEach(m=>{ const li=document.createElement('li'); li.textContent='‚Ä¢ '+m.word+' ‚Äî –≤—ã –≤–≤–µ–ª–∏: '+(m.typed||'‚àÖ'); mistakesList.appendChild(li); }); const has=state.mistakes.length>0; errorsOnlyBtn.disabled=!has; clearErrorsBtn.disabled=!has; }
    function errorsOnly(){ if(!state.mistakes.length){ drawTextCentered('–û—à–∏–±–æ–∫ –Ω–µ—Ç',{fontSize:18}); return; } const uniq=[...new Set(state.mistakes.map(m=>m.word))]; setWords(uniq); feedback.textContent='–†–µ–∂–∏–º: —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏'; if(state.mode()==='lcwc'){ enterLook(); } else { renderDictation(true); } }
    function clearErrors(){ state.mistakes=[]; store.saveMistakes([]); loadMistakesUI(); }

    // Shuffle
    function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    shuffleBtn.addEventListener('click', ()=>{ shuffleInPlace(state.words); drawTextCentered('–ü–µ—Ä–µ–º–µ—à–∞–ª–∏ –ø–æ—Ä—è–¥–æ–∫',{fontSize:18}); displayCount(); renderPreview(); runValidation(false); });

    // Events
    startBtn.addEventListener('click', ()=>{ if(state.mode()==='dictation') primeTTS(); startQuiz(); });
    pauseBtn.addEventListener('click', ()=>{ pauseTimer(); feedback.textContent='–ü–∞—É–∑–∞'; });
    resumeBtn.addEventListener('click', ()=>{ startTimer(); feedback.textContent='–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º'; answer.focus({preventScroll:false}); });
    resetTimerBtn.addEventListener('click', resetTimer);

    repeatBtn.addEventListener('click', repeat);
    revealBtn.addEventListener('click', reveal);
    skipBtn.addEventListener('click', skip);
    checkBtn.addEventListener('click', ()=>checkAnswer());
    answer.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); } });

    errorsOnlyBtn.addEventListener('click', errorsOnly);
    clearErrorsBtn.addEventListener('click', clearErrors);

    modeRadios.forEach(r=>r.addEventListener('change', ()=>{
      const isDict=(state.mode()==='dictation');
      voiceRow.style.display=isDict? 'flex':'none';
      if(state.running){ feedback.textContent='–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω'; if(isDict){ dictationStart(); } else { enterLook(); } }
    }));

    lookSecsInput.addEventListener('change', ()=>{ const v=Math.max(0, Math.min(10, parseFloat(lookSecsInput.value)||0)); lookSecsInput.value=v; store.saveLookSecs(v); });
    function lookSecs(){ return Math.max(0, Math.min(10, parseFloat(lookSecsInput.value)||2)); }

    reloadBtn.addEventListener('click', ()=>loadLists(true));

    // Init
    function init(){
      lookSecsInput.value = store.loadLookSecs();
      const speakPref = store.loadSpeakOnType();
      speakOnTypeTop.checked = speakPref; speakOnType.checked = speakPref;
      state.mistakes = store.loadMistakes();
      loadMistakesUI();
      drawTextCentered('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏‚Ä¶',{fontSize:18});
      loadLists();
      ensureVoicesReady().then(()=>{ /* stored/best voice */ });
    }
    init();

    // Utils
    function drawTextCentered(text, opts){ opts=opts||{}; resizeCanvas(); clearCanvas(); const r=cnv.getBoundingClientRect(); let w=r.width, h=r.height; let fontSize=opts.fontSize||32; const fam=opts.fontFamily||'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'; ctx.fillStyle=opts.color||'#15171a'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='600 '+fontSize+'px '+fam; while(ctx.measureText(text).width>w*0.9 && fontSize>14){ fontSize -= 2; ctx.font='600 '+fontSize+'px '+fam; } ctx.fillText(text, w/2, h/2); }
    function resizeCanvas(){ const r=cnv.getBoundingClientRect(); const w=Math.max(1,Math.floor(r.width*dpr)); const h=Math.max(1,Math.floor(r.height*dpr)); if(cnv.width!==w||cnv.height!==h){ cnv.width=w; cnv.height=h; } ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
    function clearCanvas(){ ctx.clearRect(0,0,cnv.width,cnv.height); }
  })();
  </script>
</body>
</html>
